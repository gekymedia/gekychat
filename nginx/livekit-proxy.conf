# Nginx TLS reverse-proxy for LiveKit
# -------------------------------------------------
# Places a TLS terminator in front of the LiveKit
# server running on port 7880 (plain HTTP/WS).
#
# After deploying:
#  1. Copy this file to /etc/nginx/sites-available/livekit-proxy.conf
#  2. ln -s /etc/nginx/sites-available/livekit-proxy.conf /etc/nginx/sites-enabled/
#  3. Obtain a cert: certbot --nginx -d live.gekychat.com
#  4. nginx -t && systemctl reload nginx
#  5. Update .env on the server: LIVEKIT_URL=wss://live.gekychat.com
#  6. php artisan config:clear && php artisan config:cache
# -------------------------------------------------

# Redirect HTTP → HTTPS
server {
    listen 80;
    server_name live.gekychat.com;
    return 301 https://$host$request_uri;
}

# HTTPS + WSS proxy to LiveKit
server {
    listen 443 ssl;
    http2 on;
    server_name live.gekychat.com;

    # --- TLS certificates (managed by Certbot / Let's Encrypt) ---
    ssl_certificate     /etc/letsencrypt/live/live.gekychat.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/live.gekychat.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # Proxy all traffic (HTTP + WebSocket) to local LiveKit port
    location / {
        proxy_pass         http://127.0.0.1:7880;
        proxy_http_version 1.1;

        # WebSocket upgrade headers — REQUIRED for LiveKit
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Pass real client info
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # LiveKit keeps long-lived WebSocket connections open
        proxy_read_timeout  3600s;
        proxy_send_timeout  3600s;

        # Buffer settings for media signaling
        proxy_buffering    off;
        proxy_cache        off;
    }
}
